<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<!--<head th:replace="/admin/fragments/head :: head">-->
<!--</head>-->
<head th:replace="/admin/fragments/head :: head" xmlns:th="http://www.thymeleaf.org"></head>
<!--<head th:replace="/admin/custom_css/headBHTQ :: headBHTQ" xmlns:th="http://www.thymeleaf.org"></head>-->

<!-- CSS Libraries -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
    body {
        background-color: #f5f7fa;
        font-family: 'Roboto', sans-serif;
        color: #4b4f56;
        overflow-x: hidden;
    }
    .tab-container {
        display: flex;
        align-items: center;
        background-color: #3490dc;
        padding: 10px;
        border-radius: 12px;
        color: white;
        gap: 10px;
        overflow-x: auto;
        white-space: nowrap;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .tab {
        background-color: #0066e0;
        color: white;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        transition: transform 0.3s, background-color 0.3s;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .tab.active {
        background-color: #004bb5;
        transform: scale(1.05);
    }
    .product-list, .cart-info {
        background-color: #ffffff;
        border-radius: 10px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
        padding: 20px;
        transition: transform 0.3s, box-shadow 0.3s;
    }
    .cart-info {
        background-color: #ffffff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
    }

    .cart-item {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 0.5fr;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #e0e0e0;
    }

    .cart-item:last-child {
        border-bottom: none;
    }

    .product-name {
        font-weight: bold;
        color: #333;
    }

    .quantity-input {
        width: 60px;
        text-align: center;
        font-size: 14px;
        padding: 5px;
    }

    .product-price {
        font-weight: bold;
        color: #3490dc;
        text-align: right;
    }

    .btn-remove {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
    }

    .btn-remove:hover {
        background-color: #c82333;
    }
    .btn-pay {
        background-color: #007bff;
        color: white;
        font-size: 18px;
        padding: 12px;
        width: 100%;
        border-radius: 8px;
        border: none;
        margin-top: 15px;
    }
    /* Modal slide-in from right */
    .payment-modal {
        position: fixed;
        top: 0;
        right: -100%;
        width: 400px;
        height: 100%;
        background-color: white;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.3);
        transition: right 0.3s ease;
        z-index: 1050;
        padding: 20px;
        overflow-y: auto;
    }
    .payment-modal.show {
        right: 0;
    }
</style>
<body>
<div class="container-fluid">
    <!-- thanh hóa đơn  -->
    <div class="tab-container mb-3">
        <div class="tab active" id="invoice1" onclick="switchInvoice('invoice1')">Hóa đơn 1 <span class="material-icons" onclick="closeInvoice('invoice1', event)">close</span></div>
        <button class="material-icons bg-green-500 rounded-full text-white p-1" onclick="addNewInvoice()">add</button>
    </div>

    <div class="row">
        <!-- giỏ hàng -->
        <div class="col-lg-7 cart-info">
            <h5>Giỏ hàng</h5>
            <div style="height: 500px; max-height: 500px; overflow-y: auto;">
                <div id="cartList" >

                </div>
            </div>
            <div class="total-amount">
                <strong>Tổng cộng:  </strong> <span id="totalAmount">0</span> VND
            </div>
        </div>

        <!-- danh sách sp + tìm kiếm -->
        <div class="col-lg-5 product-list">
            <h5>Danh sách sản phẩm</h5>
            <ul id="productList" class="list-group">
                <div class="container" style="max-height: 500px; overflow-y: auto;">
                    <div class="row">
                        <div class="col-md-4 mb-3 d-flex align-items-stretch" th:each="sanPham : ${danhSachSanPham}">
                            <li class="list-group-item "
                                th:attr="data-id=${sanPham.sanPham.id}, data-name=${sanPham.sanPham.ten}, data-price=${sanPham.gia}">
                                <div class="card" style="height: 200px;">
                                    <img src="path/to/image.jpg" class="card-img-top" alt="Product Image" style="height: 100px; object-fit: cover;">
                                    <div class="card-body">
                                        <h5 class="card-title" th:text="${sanPham.sanPham.ten}"></h5>
                                        <p class="card-text">
                                            <span th:text="${'(' + sanPham.mauSac.ten +' - '+ sanPham.congSuat.ten + ')'}"></span>
                                        </p>
                                        <p class="card-text">
                                            <span id="price" th:text="${sanPham.gia}"></span> VND
                                        </p>
                                    </div>
                                </div>
                            </li>
                        </div>
                    </div>
                </div>
            </ul>
            <div>
                <button class="btn-pay" onclick="togglePaymentModal()">Thanh toán</button>
            </div>
        </div>
    </div>
</div>
<!-- Payment Modal -->
<div id="paymentModal" class="payment-modal">
    <form th:action="@{/admin/san-pham/}">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <span class="material-icons" style="cursor: pointer;" onclick="togglePaymentModal()">close</span>
        </div>
        <p><strong>Tổng tiền hàng:</strong><span class="badge text-bg-warning" id="modalTotalProduct">0</span> - <span class="badge text-bg-success"id="modalTotalAmount">0</span> VND</p>
        <div class="mb-3">
            <label for="customerPaid" class="form-label">Tiền khách trả</label>
            <input type="number" id="customerPaid" class="form-control" oninput="calculateChange()">
        </div>
        <p><strong>Tiền thừa trả khách:</strong> <span id="changeAmount">0</span> VND</p>
        <div class="mb-3">
            <label>Phương thức thanh toán:</label><br>
            <input type="radio" name="paymentMethod" value="cash" checked> Tiền mặt
            <input type="radio" name="paymentMethod" value="transfer"> Chuyển khoản
        </div>
        <button class="btn btn-primary w-100" onclick="finalizePayment()">Xác nhận thanh toán</button>
    </form>
</div>

<!-- JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
<script th:replace="/admin/fragments/script :: script"></script>
<script>
    let invoiceIdCounter = 1;
    let deletedInvoiceNumbers = [];
    let carts = { 'invoice1': [] };  // Khởi tạo giỏ hàng của Hóa đơn 1 ngay từ đầu
    let currentInvoiceId = 'invoice1';

    // Khởi tạo Hóa đơn mặc định khi tải trang
    function initializeDefaultInvoice() {
        if (Object.keys(carts).length === 0) {
            addNewInvoice(true);
        } else {
            // Khôi phục các hóa đơn đã lưu trong localStorage
            Object.keys(carts).forEach(invoiceId => {
                if (!document.getElementById(invoiceId)) { // Kiểm tra nếu hóa đơn chưa tồn tại trong DOM
                    addInvoiceTab(invoiceId, invoiceId === currentInvoiceId);
                }
            });

            let maxInvoiceNumber = Math.max(...Object.keys(carts).map(id => parseInt(id.replace('invoice', ''))));
            invoiceIdCounter = maxInvoiceNumber + 1;

            switchInvoice(currentInvoiceId);
        }
    }

    // Thêm Hóa đơn mới
    function addNewInvoice(isDefault = false) {
        let invoiceNumber;
        if (deletedInvoiceNumbers.length > 0) {
            invoiceNumber = deletedInvoiceNumbers.shift(); // Lấy số hóa đơn nhỏ nhất trong các hóa đơn bị xóa
        } else {
            let maxInvoiceNumber = Math.max(...Object.keys(carts).map(id => parseInt(id.replace('invoice', ''))), 0); // Tìm số hóa đơn lớn nhất hiện có
            invoiceNumber = maxInvoiceNumber + 1; // Cộng thêm 1 vào số hóa đơn lớn nhất
        }

        const invoiceId = `invoice${invoiceNumber}`;

        addInvoiceTab(invoiceId, isDefault);

        if (!carts[invoiceId]) {
            carts[invoiceId] = [];
        }
        switchInvoice(invoiceId);
        saveCartsToLocalStorage();
    }

    // Thêm tab hóa đơn vào giao diện
    function addInvoiceTab(invoiceId, isActive = false) {
        const tabContainer = document.querySelector('.tab-container');

        const tab = document.createElement('div');
        tab.classList.add('tab');
        if (isActive) tab.classList.add('active');
        tab.id = invoiceId;
        const invoiceNumber = parseInt(invoiceId.replace('invoice', ''));
        tab.innerHTML = `Hóa đơn ${invoiceNumber} <span class="material-icons" onclick="closeInvoice('${invoiceId}', event)">close</span>`;
        tab.onclick = () => switchInvoice(invoiceId);

        tabContainer.insertBefore(tab, tabContainer.querySelector('.material-icons.bg-green-500'));
    }

    // Chuyển đổi giữa các Hóa đơn
    function switchInvoice(invoiceId) {
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.getElementById(invoiceId).classList.add('active');
        currentInvoiceId = invoiceId;
        updateCart();
    }

    // Đóng Hóa đơn
    function closeInvoice(invoiceId, event) {
        event.stopPropagation();
        const tab = document.getElementById(invoiceId);

        if (tab) {
            const invoiceNumber = parseInt(invoiceId.replace('invoice', ''));
            deletedInvoiceNumbers.push(invoiceNumber);
            deletedInvoiceNumbers.sort((a, b) => a - b);
            tab.remove();
            delete carts[invoiceId];
            saveCartsToLocalStorage();

            const remainingTabs = document.querySelectorAll('.tab');
            if (remainingTabs.length > 0) {
                // Chuyển sang hóa đơn đầu tiên còn lại
                switchInvoice(remainingTabs[0].id);
            } else {
                // Khi không còn hóa đơn nào, reset lại về hóa đơn 1
                resetInvoices();
            }
        }
    }

    function resetInvoices() {
        invoiceIdCounter = 1; // Đặt lại bộ đếm hóa đơn
        deletedInvoiceNumbers = [];
        carts = { 'invoice1': [] }; // Tạo lại hóa đơn 1
        currentInvoiceId = 'invoice1';

        // Xóa tất cả các tab hóa đơn hiện tại nhưng giữ lại nút thêm hóa đơn
        const tabContainer = document.querySelector('.tab-container');
        const addButton = tabContainer.querySelector('.material-icons.bg-green-500');
        tabContainer.innerHTML = ''; // Xóa hết các tab cũ

        // Thêm lại nút "add" sau khi xóa
        tabContainer.appendChild(addButton);

        addInvoiceTab('invoice1', true); // Thêm tab Hóa đơn 1 và đặt làm active
        updateCart(); // Cập nhật giỏ hàng
        saveCartsToLocalStorage(); // Lưu trạng thái giỏ hàng vào localStorage
    }

    // Thêm sản phẩm vào giỏ hàng của Hóa đơn hiện tại
    function addToCart(id, name, price) {
        const cart = carts[currentInvoiceId];
        const existingItem = cart.find(item => item.id === id);
        if (existingItem) {
            existingItem.quantity++;
            existingItem.total += price;
        } else {
            cart.push({ id, name, price, quantity: 1, total: price });
        }
        updateCart();
        saveCartsToLocalStorage();
    }

    // Cập nhật giao diện giỏ hàng
    function updateCart() {
        const cart = carts[currentInvoiceId];
        const cartList = document.getElementById('cartList');
        cartList.innerHTML = ''; // Clear cart content before updating
        let totalAmount = 0;
        let totalQuantity = 0;

        cart.forEach((item, index) => {
            // Create a list item with 'cart-item' class for styling
            const li = document.createElement('li');
            li.classList.add('cart-item'); // Apply 'cart-item' class here
            li.innerHTML = `
            <span class="product-name">${item.name} </span>
            <input type="number" class="form-control quantity-input" value="${item.quantity}" min="1" onchange="updateQuantity(${index}, this.value)">
            <span class="product-price">${item.total.toLocaleString()} VND</span>
            <button style="margin-left: 10px;" class="btn btn-danger btn-sm btn-remove" onclick="removeProduct(${index})"><i class="bi bi-trash-fill"></i></button>
        `;
            cartList.appendChild(li);

            // Calculate total amount
            totalAmount += item.total;
            totalQuantity += item.quantity;
        });

        // Update total amount display
        document.getElementById('totalAmount').innerText = totalAmount.toLocaleString();
        document.getElementById('modalTotalProduct').innerText = totalQuantity.toLocaleString();
        document.getElementById('modalTotalAmount').innerText = totalAmount.toLocaleString();
    }
    // Cập nhật số lượng sản phẩm trong giỏ hàng
    function updateQuantity(index, quantity) {
        const cart = carts[currentInvoiceId];
        cart[index].quantity = parseInt(quantity);
        cart[index].total = cart[index].price * cart[index].quantity;
        updateCart();
        saveCartsToLocalStorage();
    }

    // Xóa sản phẩm khỏi giỏ hàng
    function removeProduct(index) {
        carts[currentInvoiceId].splice(index, 1);
        updateCart();
        saveCartsToLocalStorage();
    }

    // Thiết lập sự kiện nhấp chuột cho các sản phẩm trong danh sách sản phẩm
    function setupProductClickEvents() {
        document.querySelectorAll('#productList .list-group-item').forEach(item => {
            item.onclick = function() {
                const id = this.getAttribute('data-id');
                const name = this.getAttribute('data-name');
                const price = parseFloat(this.getAttribute('data-price'));

                if (name && !isNaN(price)) {
                    console.log(`Adding to cart: ${name} - ${price} VND`);
                    addToCart(id, name, price);
                } else {
                    console.error("Error: Invalid product data", { name, price });
                }
            };
        });
    }

    function saveCartsToLocalStorage() {
        localStorage.setItem('carts', JSON.stringify(carts));
        localStorage.setItem('currentInvoiceId', currentInvoiceId);
        localStorage.setItem('invoiceIdCounter', invoiceIdCounter);
        localStorage.setItem('deletedInvoiceNumbers', JSON.stringify(deletedInvoiceNumbers));
    }

    function loadCartsFromLocalStorage() {
        const savedCarts = localStorage.getItem('carts');
        if (savedCarts) {
            carts = JSON.parse(savedCarts);
        }
        currentInvoiceId = localStorage.getItem('currentInvoiceId') || 'invoice1';
        invoiceIdCounter = parseInt(localStorage.getItem('invoiceIdCounter')) || 1;
        deletedInvoiceNumbers = JSON.parse(localStorage.getItem('deletedInvoiceNumbers')) || [];
    }

    // Mở/Đóng Modal Thanh toán
    function togglePaymentModal() {
        document.getElementById('paymentModal').classList.toggle('show');
    }

    // Tính tiền thừa trả lại
    // Hàm tính tiền thừa trả lại cho khách
    function calculateChange() {
        // Lấy giá trị tổng tiền hàng và tiền khách trả
        const totalAmount = parseFloat(document.getElementById('modalTotalAmount').innerText.replace(/\D/g, '')); // Loại bỏ dấu phân cách
        const customerPaid = parseFloat(document.getElementById('customerPaid').value);

        // Kiểm tra nếu đầu vào hợp lệ
        if (isNaN(customerPaid) || customerPaid <= 0) {
            document.getElementById('changeAmount').innerText = "0 VND";
            return;
        }

        // Tính tiền thừa trả lại khách
        let change = customerPaid - totalAmount;

        // Nếu tiền thừa là số âm, nghĩa là khách trả chưa đủ, nên đặt thành 0
        if (change < 0) {
            change = 0;
        }

        // Cập nhật tiền thừa trả lại cho khách (dạng có phân cách số và đơn vị VND)
        document.getElementById('changeAmount').innerText = change.toLocaleString();
    }


    // Khởi chạy hàm initializeDefaultInvoice khi trang được tải
    window.onload = function() {
        loadCartsFromLocalStorage();
        initializeDefaultInvoice();
        setupProductClickEvents();
        updateCart();
    };

    document.getElementById('price').innerText = parseFloat(document.getElementById('price').innerText).toLocaleString('vi-VN');
    document.getElementById('customerPaid').innerText = parseFloat(document.getElementById('price').innerText).toLocaleString('vi-VN');
</script>
</body>
</html>
